import { Component } from '@angular/core';
import { ActivatedRoute, Route, Router } from '@angular/router';
import { StringService } from '../../../services/string.service';
import { DocumentService } from '../../../services/document.service';
import { DialogService } from '../../../services/dialog.service';
import { applyOperation, compare, observe, generate } from 'fast-json-patch';
import { BranchOfficeService } from '../../../services/branch.service';
import { SettingsService } from '../../../services/settings.service';
import { MatDialog } from '@angular/material';
import { ServiceDialog } from './service.dialog/service.dialog';
import { CoeffDialog } from './coeff.dialog/coeff.dialog';
import { MainService } from '../../../services/main.service';
import { DataService } from '../../../services/data.service';
import { CalculationService } from '../../../services/calculation.service';
import { PartnerService } from '../../../services/partner.service';
@Component({
  selector: 'calculation',
  templateUrl: './calculation.component.html',
  styleUrls: ['./calculation.component.scss']
})
export class CalculationComponent {
  validationError = '';
  id: number;
  observer: any;
  applicationId: any;
  application: any;
  applicant: any;
  applicantBankDetails: any;
  applicantBankDetailsId: any;
  applicantAccount: any;
  applicantAccountId: any;
  branchOffice: any;
  branchAccount: any;
  branchBankDetails: any;
  date: any;
  data: any = {
  };
  coeffList: Array<any> = new Array<any>();
  coeffValue: Array<any> = new Array<any>();
  servicesList: Array<any> = new Array<any>();
  subscribes: Array<any> = new Array<any>();
  defaultPaymentDescription = 'п.1 за определение показателей качества и безопасности зерна и продуктов его переработки при экспортных и импортных операциях и перемещении внутри страны';
  constructor(private stringService: StringService, private route: ActivatedRoute,
    private documentService: DocumentService, private dialogService: DialogService,
    private branchOfficeService: BranchOfficeService, private settingsService: SettingsService,
    private dialog: MatDialog, private mainService: MainService, private dataService: DataService,
    private calculationService: CalculationService, private partnerService: PartnerService, private router: Router) {
    this.subscribes.push(this.mainService.menuActionPerformed.subscribe(action => {
      if (action == 'SAVE_CALCULATION') {
        this.save();
      }
      if (action == 'SIGN_CALCULATION') {
        this.dialogService.showSignDialog(this.id, 'CALCULATION');
      }
    }));
    this.route
      .queryParams
      .subscribe(params => {
        this.applicationId = +params['applicationId'] || 0;
        if (this.applicationId) {
          this.dialogService.showBlocker();
          this.documentService.getApplicationById(this.applicationId).subscribe(application => {
            this.application = application;
            this.partnerService.getPartnerById(this.application.applicant.id).subscribe(partner => {
              this.applicant = partner;
              this.data.paymentSender = this.applicant;
            });
            // this.applicant = this.application.applicant;
            this.branchOffice = this.application.branchOffice;
            this.branchBankDetails = this.branchOffice.bankAccountDetails[0];
            this.branchAccount = this.branchBankDetails.personalAccounts[0];
            this.data.paymentReceiver = this.branchOffice;
            this.data.paymentReceiverAccount = this.branchBankDetails;

            this.data.paymentPurpose = this.defaultPaymentDescription;
            console.log(this.application);
            this.dialogService.hideBlocker();
          });
        }
      });
    this.route.params.subscribe(params => {
      this.id = +params['id'];
      if (this.id) {
        this.dialogService.showBlocker();
        this.calculationService.getCalculationById(this.id).subscribe(calculation => {
          this.data = calculation;
          console.log(this.data);
          this.observer = observe(this.data);
          this.initModel();
          this.dialogService.hideBlocker();
        });
      }
    });
  }

  initModel() {
    this.application = this.data.application;
    this.partnerService.getPartnerById(this.data.paymentSender.id).subscribe(partner => {
      this.applicant = partner;
    });
    this.branchOffice = this.data.paymentReceiver;
    this.branchBankDetails = this.data.paymentReceiverDetails;
    this.branchAccount = this.branchBankDetails.personalAccounts[0];
    this.applicantBankDetails = this.data.paymentSenderDetails;
    this.applicantAccount = this.data.paymentSenderAccount;
    this.defaultPaymentDescription = this.data.paymentPurpose;
    this.applicantAccountId = this.applicantAccount.id;
    this.applicantBankDetailsId = this.applicantBankDetails.id;
    this.servicesList = this.data.orderItems;
    this.coeffList = this.data.priceCoefficients;
    console.log(this.applicant);
  }

  onBranchAccountChange(event) {
    this.branchAccount = event.value;
    this.data.paymentReceiverAccount = this.branchAccount;
  }

  onBranchBankDetailsChange(event) {
    this.branchBankDetails = event.value;
    this.data.paymentReceiverDetails = this.branchBankDetails;
  }

  onApplicantAccountChange(event) {
    this.applicantAccountId = event.value;
    this.applicantAccount = this.applicantBankDetails.personalAccounts.find(it => it.id == this.applicantAccountId);
    this.data.paymentSenderAccount = this.applicantAccount;
  }

  onApplicantBankDetailsChange(event) {
    this.applicantBankDetailsId = event.value;
    this.applicantBankDetails = this.applicant.bankAccountDetails.find(it => it.id == this.applicantBankDetailsId);
    this.data.paymentSenderDetails = this.applicantBankDetails;
  }

  onServiceDataRemoved(event) {
    let index = this.servicesList.findIndex(item => item.pricelistItem.id == event.pricelistItem.id);
    if (index >= 0) {
      this.servicesList.splice(index, 1);
    }
    this.recalculate();
  }

  onCoeffDataRemoved(event) {
    let index = this.coeffList.findIndex(item => item.id == event.id);
    if (index >= 0) {
      this.coeffList.splice(index, 1);
    }
    this.recalculate();
  }

  onCoeffDataChange(event) {
    this.recalculate();
  }

  onServiceDataChange(event) {
    this.recalculate();

  }


  recalculate() {
    let subTotal = 0;
    this.servicesList.forEach(item => {
      subTotal += item.orderPrice;
    });
    this.coeffList.forEach(item => {
      subTotal *= item.coefficient;
    });
    this.data.subTotalPrice = subTotal;
    this.data.vatSum = subTotal * 0.12;
    this.data.totalPrice = this.data.subTotalPrice + this.data.vatSum;
  }

  selectCoeff() {
    let dialogRef = this.dialog.open(CoeffDialog);
    dialogRef.componentInstance.propertySelected.subscribe(item => {
      if (!this.coeffList.find(it => it.id == item.id)) {
        this.coeffList.push(item);
        this.coeffValue.push(item.coefficient);
        this.dialogService.showNotification(item.coefName + ' добавлен');
        this.recalculate();
      }

    });
  }
  selectService() {
    let dialogRef = this.dialog.open(ServiceDialog, { data: { branchOffice: this.branchOffice } });
    dialogRef.componentInstance.propertySelected.subscribe(item => {
      if (!this.servicesList.find(it => it.id == item.id)) {
        let orderItem = {
          id: null,
          version: null,
          pricelistItem: item,
          amount: 1,
          price: item.amount,
          coefficient: 1,
          orderPrice: item.amount
        };
        this.servicesList.push(orderItem);
        this.recalculate();
        this.dialogService.showNotification(item.name + ' добавлен');
      }

    });
  }

  onDateChange(event) {
    this.date = this.dataService.dateOffset(event.value);;
    this.data.creationDate = this.date.getTime();
  }

  ngOnInit() {
    if (this.data.creationDate) {
      this.date = new Date(this.data.creationDate);
    } else {
      this.date = new Date();
      this.data.creationDate = this.date.getTime();
    }
    this.mainService.menuChange.emit({ name: 'CALCULATION_EDIT', state: this.id ? true : false });

  }

  beforeSave() {
    if (this.id) {
      this.servicesList.forEach(item => {

        delete item.uuid;
        delete item.pricelistItem.uuid;
        if (!item.id) {
          let obj = {id: item.pricelistItem.id, name: item.pricelistItem.name, amount: item.pricelistItem.amount, calcStrategy: item.pricelistItem.calcStrategy, version: item.pricelistItem.version};
          item.pricelistItem = obj;
        }

      });
    } else {
      this.data.application = {id: this.application.id, version: this.application.version};
      this.data.paymentReceiver = {id: this.branchOffice.id, version: this.branchOffice.version };
      this.data.paymentReceiverDetails = {id: this.branchBankDetails.id, version: this.branchBankDetails.version};
      this.data.paymentReceiverAccount = {id: this.branchAccount.id, version: this.branchAccount.version};
      this.data.paymentSender = {id: this.applicant.id, version: this.applicant.version};
      this.data.paymentSenderDetails = {id: this.applicantBankDetails.id, version: this.applicantBankDetails.version};
      this.data.paymentSenderAccount = {id: this.applicantAccount.id, version: this.applicantAccount.id};
      this.servicesList.forEach(item => {
        delete item.uuid;
        delete item.pricelistItem.uuid;
        let obj = {id: item.pricelistItem.id, name: item.pricelistItem.name, amount: item.pricelistItem.amount, calcStrategy: item.pricelistItem.calcStrategy, version: item.pricelistItem.version};
        item.pricelistItem = obj;
      });
      this.data.priceCoefficients = this.coeffList;
      this.data.orderItems = this.servicesList;
      this.data.id = null;
      this.data.version = null;
    }
  }

  checkValidation() {
    let error = true;
    this.validationError = '';
    if (!this.data.calculationNumber) {
      this.validationError += 'Номер калькуляции должен быть заполнен. ';
      error = false;
    }
    if (!this.data.creationDate) {
      this.validationError += 'Дата должна быть заполнена. ';
      error = false;
    }
    if (!this.branchOffice) {
      this.validationError += 'Филиал должен быть заполнен. ';
      error = false;
    }
    if (!this.branchBankDetails) {
      this.validationError += 'Банковские реквизиты получателя должны быть заполнены. ';
      error = false;
    }
    if (!this.branchAccount) {
      this.validationError += 'Счет получателя должен быть заполнен. ';
      error = false;
    }
    if (!this.applicantBankDetails) {
      this.validationError += 'Банковские реквизиты плательщика должны быть заполнены. ';
      error = false;
    }
    if (!this.applicantAccount) {
      this.validationError += 'Счет плательщика должен быть заполнен. ';
      error = false;
    }

    if (this.servicesList.length <= 0) {
      this.validationError += 'Услуги должны быть заполнены. ';
      error = false;
    }
    return error;
  }

  save() {
    if(this.checkValidation()) {
    this.beforeSave();
    if (this.id) {
      let patch = generate(this.observer);
      console.log(patch);
      this.calculationService.updateCalculation(patch, this.id).subscribe(res => {
        this.dialogService.showNotification('Калькуляция сохранена');
        this.router.navigate(['main/document/application/' + this.data.application.id + '/view']);
      });
    } else {
      console.log(this.data);
      console.log(JSON.stringify(this.data));
      this.calculationService.createCalculation(this.data).subscribe(res => {
        this.dialogService.showNotification('Калькуляция сохранена');
        this.router.navigate(['main/document/application/' + this.applicationId + '/view']);
        console.log(res);
      });
    }
  } else {
    this.dialogService.showMessageDlg('Ошибка валидации', this.validationError);
  }
}

}
